<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nova Vision AI | Security Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');

        :root {
            --primary: #8b5cf6;
            --primary-dark: #6d28d9;
            --bg: #030712;
        }

        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #030712; }
        ::-webkit-scrollbar-thumb { background: #1e1b4b; border-radius: 2px; }
        
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 5;
            background: linear-gradient(0deg, rgba(139, 92, 246, 0) 0%, rgba(139, 92, 246, 0.1) 50%, rgba(139, 92, 246, 0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scan 3s linear infinite;
            pointer-events: none;
        }

        @keyframes scan {
            0% { bottom: 100%; }
            100% { bottom: -100px; }
        }

        .pulse-border {
            animation: pulse-indigo 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-indigo {
            0%, 100% { border-color: rgba(139, 92, 246, 0.3); }
            50% { border-color: rgba(139, 92, 246, 0.8); }
        }

        .terminal-text {
            animation: typing 0.05s steps(20);
        }
    </style>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.37.0"
      }
    }
    </script>
</head>
<body class="bg-[#030712] text-slate-300 overflow-hidden">
    <div id="app" class="flex flex-col h-screen w-full max-w-lg mx-auto bg-[#030712] border-x border-indigo-950/50 shadow-2xl relative overflow-hidden">
        
        <!-- Top Status Bar -->
        <header class="p-4 bg-[#030712]/90 backdrop-blur-xl border-b border-indigo-900/40 flex justify-between items-center z-30">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="absolute inset-0 bg-violet-500 blur-md opacity-20"></div>
                    <div class="relative bg-indigo-950 p-2 rounded-lg border border-indigo-500/30">
                        <i data-lucide="shield-check" class="text-violet-400 w-5 h-5"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-sm font-black tracking-widest text-white uppercase italic">Nova <span class="text-violet-500 not-italic">Vision</span></h1>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span id="status-indicator" class="w-1.5 h-1.5 rounded-full bg-slate-600"></span>
                        <p id="status-text" class="text-[9px] mono text-slate-500 uppercase tracking-tighter">System: Idle</p>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-2 px-3 py-1.5 bg-indigo-950/30 rounded-md border border-indigo-900/50">
                <div id="conn-dot" class="w-1.5 h-1.5 rounded-full bg-rose-500"></div>
                <span id="conn-text" class="text-[9px] mono font-bold text-slate-400 uppercase">Disconnected</span>
            </div>
        </header>

        <main class="flex-1 flex flex-col p-4 space-y-4 overflow-hidden relative">
            <!-- Sensor Feed -->
            <section id="viewfinder" class="relative group rounded-xl overflow-hidden border border-indigo-900/50 shadow-inner bg-black aspect-video cursor-crosshair">
                <video id="camera-video" playsinline muted autoplay class="w-full h-full object-cover grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-500"></video>
                <div id="camera-overlay" class="absolute inset-0 bg-black opacity-0 transition-opacity duration-1000 pointer-events-none"></div>
                <div class="scanline"></div>
                
                <!-- HUD Overlays -->
                <div class="absolute top-3 left-3 flex flex-col gap-1 pointer-events-none">
                    <div class="bg-black/60 backdrop-blur-sm px-2 py-1 rounded-sm border-l-2 border-violet-500 text-[9px] mono text-violet-400 uppercase">
                        Feed: Primary_01
                    </div>
                    <div class="bg-black/60 backdrop-blur-sm px-2 py-1 rounded-sm border-l-2 border-cyan-500 text-[9px] mono text-cyan-400 uppercase">
                        Lat: 34.0522Â° N
                    </div>
                </div>

                <div class="absolute bottom-3 right-3 z-10">
                    <div id="mode-badge" class="flex items-center gap-1.5 bg-black/60 backdrop-blur-md px-2.5 py-1 rounded-full border border-white/5">
                        <i id="mode-icon" data-lucide="sun" class="w-3.5 h-3.5 text-amber-400"></i>
                        <span id="mode-text" class="text-[9px] mono text-white uppercase">Day</span>
                    </div>
                </div>
            </section>

            <!-- Control Interface -->
            <div class="grid grid-cols-2 gap-3">
                <button id="btn-standby" class="group relative flex items-center justify-center gap-3 p-4 rounded-xl font-bold transition-all border border-rose-900/50 bg-rose-950/20 text-rose-500 hover:bg-rose-900/30">
                    <div class="absolute inset-0 bg-rose-500/5 blur-xl group-hover:opacity-100 opacity-0 transition-opacity"></div>
                    <i data-lucide="power" class="w-5 h-5"></i>
                    <span class="text-xs tracking-widest uppercase italic">Sleep</span>
                </button>
                <button id="btn-active" class="group relative flex items-center justify-center gap-3 p-4 rounded-xl font-bold transition-all border border-indigo-900/50 bg-indigo-950/20 text-slate-500">
                    <i data-lucide="eye" class="w-5 h-5"></i>
                    <span class="text-xs tracking-widest uppercase italic">Watch</span>
                </button>
            </div>

            <!-- Module Management -->
            <div class="grid grid-cols-3 gap-3">
                <button id="btn-connect" class="flex flex-col items-center justify-center gap-2 p-3 rounded-xl border border-indigo-500/30 bg-indigo-600/10 text-indigo-400 hover:bg-indigo-600/20 transition-all group">
                    <i id="conn-icon" data-lucide="link" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    <span id="conn-btn-label" class="text-[10px] mono uppercase font-bold">Uplink</span>
                </button>
                
                <button id="btn-scan" class="flex flex-col items-center justify-center gap-2 p-3 rounded-xl bg-slate-900/50 border border-slate-800 text-slate-400 hover:text-white transition-all group">
                    <i id="scan-icon" data-lucide="zap" class="w-5 h-5 group-hover:rotate-12 transition-transform"></i>
                    <span class="text-[10px] mono uppercase font-bold">Capture</span>
                </button>

                <button id="btn-test" class="flex flex-col items-center justify-center gap-2 p-3 rounded-xl bg-violet-950/30 border border-violet-900/50 text-violet-400 hover:bg-violet-900/40 transition-all group">
                    <i data-lucide="audio-lines" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] mono uppercase font-bold">Signal</span>
                </button>
            </div>

            <!-- Sync Task -->
            <div id="sync-panel" class="hidden animate-in fade-in slide-in-from-top-2 duration-300">
                <div class="p-3 bg-violet-500/5 border border-violet-500/20 rounded-xl flex items-center gap-3">
                    <div class="p-1.5 bg-violet-500/20 rounded-md">
                        <i data-lucide="cloud-download" class="w-4 h-4 text-violet-400"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-[10px] mono text-violet-300 uppercase font-bold">Fetching Command Audio...</p>
                        <div class="h-1 bg-slate-800 rounded-full mt-1.5 overflow-hidden">
                            <div id="sync-bar" class="h-full bg-violet-500 transition-all duration-300 w-0 shadow-[0_0_8px_rgba(139,92,246,0.5)]"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Terminal Logs -->
            <div class="flex-1 min-h-0 bg-[#020617] rounded-xl border border-indigo-900/30 flex flex-col overflow-hidden shadow-2xl">
                <div class="px-4 py-2 border-b border-indigo-900/30 bg-indigo-950/20 flex justify-between items-center">
                    <span class="text-[9px] mono font-bold text-indigo-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-pulse"></span>
                        Telemetry Log
                    </span>
                    <span class="text-[8px] mono text-indigo-700">v3.1.0-STABLE</span>
                </div>
                <div id="log-container" class="flex-1 overflow-y-auto p-4 space-y-1.5 mono text-[10px]">
                    <div class="text-indigo-900">Booting kernel...</div>
                </div>
            </div>
        </main>

        <!-- Lockdown Overlay -->
        <div id="stealth-overlay" class="absolute inset-0 bg-[#030712]/95 z-50 hidden flex items-center justify-center backdrop-blur-2xl cursor-pointer">
            <div class="text-center relative">
                <div class="absolute -inset-10 bg-violet-500/10 blur-[100px] animate-pulse"></div>
                <div class="relative flex flex-col items-center">
                    <div class="p-8 rounded-full border border-indigo-500/20 bg-indigo-950/30 shadow-2xl mb-6 group">
                        <i data-lucide="eye-off" class="w-16 h-16 text-violet-500 transition-transform duration-700 group-hover:scale-110"></i>
                    </div>
                    <h2 class="text-white text-xs font-black tracking-[0.5em] uppercase mb-2">Observation Mode</h2>
                    <p class="text-indigo-700 text-[9px] mono uppercase tracking-widest">Active Background Surveillance</p>
                    
                    <div class="mt-8 flex gap-1">
                        <div class="w-1 h-1 bg-violet-500/40 rounded-full animate-ping"></div>
                        <div class="w-1 h-1 bg-violet-500/40 rounded-full animate-ping" style="animation-delay: 0.2s"></div>
                        <div class="w-1 h-1 bg-violet-500/40 rounded-full animate-ping" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI, Modality } from "@google/genai";

        // --- CONFIG ---
        const COMMANDS = [
            { key: "STAND", prompt: "Say clearly: Stand", repeats: 2 },
            { key: "SIT", prompt: "Say clearly: Sit", repeats: 2 },
            { key: "DOWN", prompt: "Say clearly: Down", repeats: 2 },
            { key: "SIDE", prompt: "Say clearly: Side", repeats: 2 },
            { key: "PAW SHAKE", prompt: "Say clearly: Paw Shake", repeats: 2 },
            { key: "GOOD DOG", prompt: "Say cheerfully: Well done, good dog!", repeats: 1 },
            { key: "NO", prompt: "Say firmly: No!", repeats: 1 },
        ];
        const SCAN_LIMIT_SECONDS = 15;

        // --- APP STATE ---
        let state = {
            active: false,
            connected: false,
            dimmed: false,
            scanning: false,
            processing: false,
            logs: [],
            voiceCache: new Map(),
            playing: false
        };

        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
        let audioCtx = null;
        let serial = { port: null, writer: null };
        let screenLock = null;
        let scanTimer = null;

        // --- UTILS ---
        function writeLog(msg, level = 'info') {
            const time = new Date().toLocaleTimeString('en-GB', { hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit' });
            state.logs.push({ time, msg, level });
            if (state.logs.length > 50) state.logs.shift();
            
            const container = document.getElementById('log-container');
            container.innerHTML = state.logs.map(log => `
                <div class="flex gap-2 log-entry terminal-text">
                    <span class="text-indigo-900 shrink-0">${log.time}</span>
                    <span class="${
                        level === 'error' ? 'text-rose-500' :
                        level === 'success' ? 'text-emerald-400' :
                        level === 'warning' ? 'text-amber-500 font-bold' :
                        'text-indigo-400'
                    }">${log.msg}</span>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        async function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            if (audioCtx.state === 'suspended') await audioCtx.resume();
        }

        function pcmToBuffer(data, ctx) {
            const int16 = new Int16Array(data.buffer, data.byteOffset, data.byteLength / 2);
            const buffer = ctx.createBuffer(1, int16.length, 24000);
            const channel = buffer.getChannelData(0);
            for (let i = 0; i < int16.length; i++) channel[i] = int16[i] / 32768.0;
            return buffer;
        }

        // --- ACTIONS ---
        async function preloadSignals() {
            const panel = document.getElementById('sync-panel');
            const bar = document.getElementById('sync-bar');
            panel.classList.remove('hidden');
            writeLog("Synchronizing command signatures...", "info");

            let count = 0;
            for (const cmd of COMMANDS) {
                try {
                    const res = await ai.models.generateContent({
                        model: "gemini-2.5-flash-preview-tts",
                        contents: [{ parts: [{ text: cmd.prompt }] }],
                        config: {
                            responseModalities: [Modality.AUDIO],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: 'Kore' } } },
                        }
                    });
                    const base64 = res.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    if (base64) {
                        const binary = atob(base64);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                        state.voiceCache.set(cmd.key, pcmToBuffer(bytes, audioCtx));
                        count++;
                        bar.style.width = `${(count / COMMANDS.length) * 100}%`;
                    }
                } catch (e) { writeLog(`Signal Error: ${cmd.key}`, "error"); }
            }
            writeLog(`Audio Uplink Ready (${count}/${COMMANDS.length})`, "success");
            setTimeout(() => panel.classList.add('hidden'), 3000);
        }

        async function triggerSignal(key) {
            if (state.playing) return;
            const buffer = state.voiceCache.get(key);
            const config = COMMANDS.find(c => c.key === key);
            if (!buffer || !audioCtx) return;

            state.playing = true;
            try {
                await initAudio();
                writeLog(`BROADCASTING: ${key}`, "warning");
                for (let i = 0; i < config.repeats; i++) {
                    const source = audioCtx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioCtx.destination);
                    const ended = new Promise(r => source.onended = r);
                    source.start();
                    await ended;
                    if (i < config.repeats - 1) await new Promise(r => setTimeout(r, 600));
                }
            } catch (e) { writeLog("Signal Interrupt", "error"); }
            finally { state.playing = false; }
        }

        async function runAnalysis() {
            if (state.processing) return;
            state.processing = true;
            updateUI();
            
            toggleStealth(false);
            writeLog("Capturing high-res frame...", "info");
            
            scanTimer = setTimeout(() => {
                writeLog("Cloud sync timed out", "error");
                state.processing = false;
                if (state.active) toggleStealth(true);
                updateUI();
            }, SCAN_LIMIT_SECONDS * 1000);

            try {
                const video = document.getElementById('camera-video');
                const canvas = document.createElement('canvas');
                const scale = Math.min(800 / video.videoWidth, 600 / video.videoHeight, 1);
                canvas.width = video.videoWidth * scale; canvas.height = video.videoHeight * scale;
                canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                const b64 = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];

                const res = await ai.models.generateContent({
                    model: 'gemini-3-pro-preview',
                    contents: {
                        parts: [
                            { text: "Analyze subject position. 0=Empty, 1=Standing, 2=Sitting, 3=Lying, 4=Horizontal. Reply with DIGIT ONLY." },
                            { inlineData: { mimeType: 'image/jpeg', data: b64 } }
                        ]
                    }
                });
                const result = res.text?.trim().match(/[0-4]/)?.[0] || "0";
                writeLog(`Classification: ${result}`, "success");
                
                if (serial.writer && state.connected) {
                    await serial.writer.write(new TextEncoder().encode(result));
                    writeLog(`Payload delivered: ${result}`, "info");
                }
            } catch (e) { writeLog(`API Error: ${e.message}`, "error"); }
            finally {
                clearTimeout(scanTimer);
                state.processing = false;
                if (state.active) toggleStealth(true);
                updateUI();
            }
        }

        async function openUplink() {
            if (!navigator.serial) return writeLog("Serial Port Blocked", "error");
            state.scanning = true;
            updateUI();
            try {
                writeLog("Polling for Uplink Module...", "info");
                serial.port = await navigator.serial.requestPort();
                await serial.port.open({ baudRate: 9600 });
                serial.writer = serial.port.writable.getWriter();
                state.connected = true;
                writeLog("Module Synchronized", "success");
                
                const reader = serial.port.readable.getReader();
                (async () => {
                    const decoder = new TextDecoder();
                    try {
                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;
                            const input = decoder.decode(value).trim().toUpperCase();
                            if (input) {
                                writeLog(`Incoming: ${input}`, "info");
                                if (input.includes("PHOTO")) {
                                    if (state.active) runAnalysis();
                                } else {
                                    const match = COMMANDS.find(c => input.includes(c.key));
                                    if (match) triggerSignal(match.key);
                                }
                            }
                        }
                    } catch (e) { writeLog("Uplink Lost", "error"); }
                    finally { state.connected = false; updateUI(); }
                })();
            } catch (e) { writeLog(`Uplink Failed: ${e.message}`, "error"); }
            finally { state.scanning = false; updateUI(); }
        }

        // --- UI RE-RENDER ---
        function toggleStealth(val) {
            state.dimmed = val;
            const overlay = document.getElementById('stealth-overlay');
            const camCover = document.getElementById('camera-overlay');
            const badgeIcon = document.getElementById('mode-icon');
            const badgeText = document.getElementById('mode-text');
            
            if (val) {
                overlay.classList.remove('hidden');
                camCover.classList.replace('opacity-0', 'opacity-90');
                badgeIcon.setAttribute('data-lucide', 'moon');
                badgeIcon.classList.replace('text-amber-400', 'text-violet-400');
                badgeText.textContent = "Night";
            } else {
                overlay.classList.add('hidden');
                camCover.classList.replace('opacity-90', 'opacity-0');
                badgeIcon.setAttribute('data-lucide', 'sun');
                badgeIcon.classList.replace('text-violet-400', 'text-amber-400');
                badgeText.textContent = "Day";
            }
            lucide.createIcons();
        }

        function updateUI() {
            const btnSleep = document.getElementById('btn-standby');
            const btnWatch = document.getElementById('btn-active');
            const btnLink = document.getElementById('btn-connect');
            const statusIndicator = document.getElementById('status-indicator');
            const statusTxt = document.getElementById('status-text');
            const dot = document.getElementById('conn-dot');
            const connTxt = document.getElementById('conn-text');
            const connIcon = document.getElementById('conn-icon');
            const connLabel = document.getElementById('conn-btn-label');
            const scanIcon = document.getElementById('scan-icon');

            // Sleep vs Watch buttons
            btnSleep.className = `group relative flex items-center justify-center gap-3 p-4 rounded-xl font-bold transition-all border ${!state.active ? 'border-rose-500 bg-rose-600 text-white shadow-[0_0_20px_rgba(244,63,94,0.3)]' : 'border-rose-900/50 bg-rose-950/20 text-rose-500'}`;
            btnWatch.className = `group relative flex items-center justify-center gap-3 p-4 rounded-xl font-bold transition-all border ${state.active ? 'border-indigo-500 bg-indigo-600 text-white shadow-[0_0_20px_rgba(99,102,241,0.3)]' : 'border-indigo-900/50 bg-indigo-950/20 text-slate-500'}`;
            
            // System status
            statusIndicator.className = `w-1.5 h-1.5 rounded-full ${state.processing ? 'bg-violet-400 animate-pulse' : (state.active ? 'bg-indigo-400' : 'bg-slate-700')}`;
            statusTxt.textContent = `System: ${state.processing ? 'Syncing' : (state.active ? 'Monitoring' : 'Idle')}`;
            
            // Conn status
            dot.className = `w-1.5 h-1.5 rounded-full ${state.connected ? 'bg-emerald-500 shadow-[0_0_6px_rgba(16,185,129,0.8)]' : 'bg-rose-500 shadow-[0_0_6px_rgba(244,63,94,0.8)]'}`;
            connTxt.textContent = state.connected ? 'Linked' : 'Disconnected';
            
            // Uplink button
            connIcon.setAttribute('data-lucide', state.scanning ? 'loader-2' : (state.connected ? 'link-2' : 'link'));
            if (state.scanning) connIcon.classList.add('animate-spin'); else connIcon.classList.remove('animate-spin');
            connLabel.textContent = state.scanning ? 'Polling' : (state.connected ? 'Uplinked' : 'Uplink');
            
            // Scan button
            if (state.processing) scanIcon.classList.add('animate-spin', 'text-violet-400'); else scanIcon.classList.remove('animate-spin', 'text-violet-400');
            
            lucide.createIcons();
        }

        // --- INIT ---
        window.addEventListener('load', async () => {
            lucide.createIcons();
            
            // Video Init
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('camera-video').srcObject = stream;
                writeLog("Vision sensors online", "success");
            } catch (e) { writeLog("Sensor Failure: No Camera", "error"); }

            // Audio Preload
            await initAudio();
            if (process.env.API_KEY) preloadSignals();

            // Interactions
            document.getElementById('btn-standby').onclick = () => {
                state.active = false;
                writeLog("Entering sleep protocol", "warning");
                toggleStealth(false);
                if (screenLock) { screenLock.release(); screenLock = null; }
                updateUI();
            };

            document.getElementById('btn-active').onclick = async () => {
                state.active = true;
                await initAudio();
                writeLog("Watch protocol active", "success");
                toggleStealth(true);
                if (navigator.wakeLock) screenLock = await navigator.wakeLock.request('screen');
                updateUI();
            };

            document.getElementById('btn-connect').onclick = openUplink;
            document.getElementById('btn-scan').onclick = () => { if (state.active) runAnalysis(); };
            document.getElementById('btn-test').onclick = () => {
                const random = COMMANDS[Math.floor(Math.random() * COMMANDS.length)];
                triggerSignal(random.key);
            };

            const wakeTrigger = () => {
                if (state.dimmed) {
                    toggleStealth(false);
                    setTimeout(() => { if (state.active && !state.processing) toggleStealth(true); }, 8000);
                }
            };
            document.getElementById('viewfinder').onclick = wakeTrigger;
            document.getElementById('stealth-overlay').onclick = wakeTrigger;
        });
    </script>
</body>
</html>
